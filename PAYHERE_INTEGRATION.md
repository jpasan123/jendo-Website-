# PayHere Payment Gateway Integration

This document provides a complete guide for the PayHere payment gateway integration implemented in your Next.js application.

## Overview

The integration includes:
- ✅ Secure payment form generation with proper hash validation
- ✅ Payment notification webhook handling
- ✅ Google Sheets integration for order tracking
- ✅ Success and cancel page handling
- ✅ TypeScript support with proper type definitions

## File Structure

```
├── app/
│   ├── api/
│   │   ├── checkout/route.ts          # Payment initiation API
│   │   └── payhere/
│   │       └── webhook/route.ts       # Payment notification handler
│   ├── checkout/
│   │   ├── page.tsx                   # Checkout form page
│   │   ├── success/page.tsx           # Payment success page
│   │   └── cancel/page.tsx            # Payment cancel page
├── components/ui/
│   └── payhere-form.tsx               # PayHere form component
├── lib/
│   ├── payhere.ts                     # PayHere utilities and types
│   └── googleSheets.ts                # Google Sheets integration
└── .env                               # Environment variables
```

## Environment Variables

```env
# PayHere Configuration
NEXT_PUBLIC_PAYHERE_MERCHANT_ID=239581
PAYHERE_SECRET=MjE4NzIyMjA4NDMxMzE4NzQ5MDQ2NTQyNTA1NTExODE3MTk0ODYz
NEXT_PUBLIC_BASE_URL=http://localhost:3001

# Google Sheets Configuration
GOOGLE_SHEET_ID=1h1Ck_G6AWw4A0Ft9wvnU4d3UT8vtXXNwpv9lkEweMNA
GOOGLE_SERVICE_ACCOUNT_EMAIL=jendo-forms-service-account@jendo-project.iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n[YOUR_PRIVATE_KEY]\n-----END PRIVATE KEY-----\n"
```

## Payment Flow

### 1. Customer Checkout Process

1. **Cart Review**: Customer reviews items in cart
2. **Billing Information**: Customer fills out billing details
3. **Payment Initiation**: Form data sent to `/api/checkout`
4. **Hash Generation**: Server generates secure hash using PayHere algorithm
5. **Redirect to PayHere**: Customer redirected to PayHere payment gateway
6. **Payment Processing**: Customer completes payment on PayHere
7. **Notification**: PayHere sends webhook to `/api/payhere/webhook`
8. **Verification**: Server verifies payment signature
9. **Data Storage**: Payment details saved to Google Sheets
10. **Redirect**: Customer redirected to success/cancel page

### 2. Hash Generation Algorithm

According to PayHere documentation:

```typescript
// Payment Hash (for checkout)
hash = MD5(merchant_id + order_id + amount_formatted + currency + MD5(merchant_secret).toUpperCase()).toUpperCase()

// Notification Verification Hash
local_md5sig = MD5(merchant_id + order_id + payhere_amount + payhere_currency + status_code + MD5(merchant_secret).toUpperCase()).toUpperCase()
```

### 3. Payment Status Codes

- `2` - Success
- `0` - Pending
- `-1` - Canceled
- `-2` - Failed
- `-3` - Chargedback

## API Endpoints

### POST `/api/checkout`

Initiates a payment request.

**Request Body:**
```json
{
  "first_name": "John",
  "last_name": "Doe",
  "email": "john@example.com",
  "phone": "+1234567890",
  "address": "123 Main St",
  "city": "Colombo",
  "country": "Sri Lanka",
  "amount": 100.00,
  "currency": "USD",
  "items": "Product Name",
  "order_id": "ORDER_123456"
}
```

**Response:**
```json
{
  "success": true,
  "payherePayment": {
    "merchant_id": "239581",
    "return_url": "http://localhost:3001/checkout/success",
    "cancel_url": "http://localhost:3001/checkout/cancel",
    "notify_url": "http://localhost:3001/api/payhere/webhook",
    "order_id": "ORDER_123456",
    "items": "Product Name",
    "currency": "USD",
    "amount": "100.00",
    "first_name": "John",
    "last_name": "Doe",
    "email": "john@example.com",
    "phone": "+1234567890",
    "address": "123 Main St",
    "city": "Colombo",
    "country": "Sri Lanka",
    "hash": "GENERATED_HASH"
  }
}
```

### POST `/api/payhere/webhook`

Handles payment notifications from PayHere.

**PayHere sends form-encoded data:**
- `merchant_id` - PayHere Merchant ID
- `order_id` - Order ID sent by merchant
- `payment_id` - Unique Payment ID generated by PayHere
- `payhere_amount` - Total amount of payment
- `payhere_currency` - Currency code (LKR/USD/GBP/EUR/AUD)
- `status_code` - Payment status code
- `md5sig` - Encrypted signature for verification
- `method` - Payment method (VISA, MASTER, AMEX, etc.)
- `status_message` - Message from payment gateway

## Google Sheets Integration

Payment data is automatically saved to Google Sheets with the following columns:

- `timestamp` - Payment timestamp
- `order_id` - Order identifier
- `payment_id` - PayHere payment ID
- `amount` - Payment amount
- `currency` - Payment currency
- `status_code` - Payment status
- `status_message` - Status description
- `payment_method` - Payment method used
- `merchant_id` - Merchant identifier
- `card_holder_name` - Card holder name (if available)
- `card_no` - Masked card number (if available)
- `card_expiry` - Card expiry (if available)

## Security Features

### 1. Hash Verification
- All payments use MD5 hash verification
- Hash generated using merchant secret (server-side only)
- Webhook notifications verified before processing

### 2. Environment Security
- Merchant secret stored in environment variables
- Google service account credentials secured
- No sensitive data exposed to client-side

### 3. Data Validation
- Required field validation on checkout
- Payment signature verification on webhook
- Type safety with TypeScript

## Testing

### 1. Local Testing

1. Start the development server:
```bash
npm run dev
```

2. Navigate to `http://localhost:3001/checkout`

3. Fill out the checkout form with test data

4. Submit the form to initiate payment

### 2. Webhook Testing

**Note**: PayHere webhooks require a publicly accessible URL. For local testing:

1. Use ngrok or similar service to expose your local server
2. Update `NEXT_PUBLIC_BASE_URL` in `.env` to your public URL
3. Test payments will trigger webhook calls

### 3. Production Deployment

1. Update environment variables for production:
   - Set `NEXT_PUBLIC_BASE_URL` to your production domain
   - Ensure webhook URL is publicly accessible
   - Verify Google Sheets permissions

2. Test with small amounts first

3. Monitor Google Sheets for payment records

## Troubleshooting

### Common Issues

1. **Hash Mismatch Error**
   - Verify merchant secret is correct
   - Check amount formatting (use 2 decimal places)
   - Ensure no extra spaces in concatenated string

2. **Webhook Not Receiving Data**
   - Verify webhook URL is publicly accessible
   - Check server logs for errors
   - Ensure POST method is handled correctly

3. **Google Sheets Not Updating**
   - Verify service account permissions
   - Check Google Sheets ID is correct
   - Review error logs in webhook handler

### Debug Tips

1. Enable console logging in webhook handler
2. Test hash generation with known values
3. Use PayHere sandbox for initial testing
4. Monitor network requests in browser dev tools

## Production Checklist

- [ ] Update `NEXT_PUBLIC_BASE_URL` to production domain
- [ ] Verify PayHere merchant account is live (not sandbox)
- [ ] Test webhook URL accessibility
- [ ] Confirm Google Sheets integration works
- [ ] Test complete payment flow
- [ ] Set up error monitoring
- [ ] Configure SSL certificate
- [ ] Test with small amounts first

## Support

For PayHere-specific issues:
- PayHere Documentation: https://www.payhere.lk/docs/
- PayHere Support: support@payhere.lk

For integration issues:
- Check server logs for detailed error messages
- Verify environment variables are set correctly
- Test webhook endpoint independently